# Default values for stackeye-valkey.
# This is a YAML-formatted file.

replicaCount: 1

image:
  repository: valkey/valkey
  # Pin to specific minor version for reproducibility
  tag: "8.0-alpine"
  pullPolicy: IfNotPresent

nameOverride: ""
fullnameOverride: ""

service:
  type: ClusterIP
  port: 6379

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 256Mi

# Valkey configuration
valkey:
  # Maximum memory limit for Valkey (set below container limit to prevent OOMKilled)
  maxmemory: "480mb"
  # Policy when maxmemory is reached (noeviction = fail writes, never lose data)
  maxmemoryPolicy: "noeviction"
  # Disable AOF for performance (RDB snapshots provide durability)
  appendonly: "no"
  # RDB snapshot: save after 60 seconds if at least 1000 keys changed
  save: "60 1000"

# Persistence configuration
# WARNING: If persistence.enabled=false, data is stored in emptyDir and lost on pod restart
persistence:
  enabled: true
  # DigitalOcean block storage class
  storageClass: "do-block-storage"
  size: 5Gi
  accessMode: ReadWriteOnce

# Security context for the pod
podSecurityContext:
  fsGroup: 1000

# Security context for the container
securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL

# Liveness probe configuration
livenessProbe:
  enabled: true
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

# Readiness probe configuration
readinessProbe:
  enabled: true
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3
  successThreshold: 1

nodeSelector: {}

tolerations: []

affinity: {}

# Pod annotations
podAnnotations: {}

# Service account
serviceAccount:
  create: false
  name: ""

# Authentication configuration
# WARNING: Authentication is disabled by default for development simplicity
# For production, enable auth and use existingSecret for GitOps workflows
auth:
  enabled: false
  # Password for requirepass (only used if existingSecret is not set)
  # SECURITY: For production, use existingSecret instead of inline password
  password: ""
  # Use existing secret for password (recommended for GitOps)
  # Secret must have key specified by passwordKey
  existingSecret: ""
  # Key in secret containing the password
  passwordKey: "password"

# Network policy configuration
# Restricts ingress to Valkey from only authorized stackeye components
# NOTE: Requires CNI with NetworkPolicy support (Cilium, Calico)
# NOTE: Only allows access from pods in the SAME namespace
networkPolicy:
  enabled: true
  # Pod selectors allowed to access Valkey on port 6379
  # Uses OR logic - any matching selector grants access
  # WARNING: Each selector MUST have non-empty matchLabels
  # WARNING: Empty matchLabels would allow ALL pods (security risk)
  allowedSelectors:
    - matchLabels:
        app.kubernetes.io/name: stackeye-worker
    - matchLabels:
        app.kubernetes.io/name: stackeye-controller
  # Egress policy configuration (defense-in-depth)
  # When enabled, restricts outbound connections from Valkey pods
  egress:
    # Enable egress restrictions (default: false for backward compatibility)
    enabled: false
    # Allow DNS queries to kube-dns/coredns (port 53 UDP/TCP)
    # Required for Kubernetes service discovery
    allowDNS: true
    # Namespace where kube-dns/coredns runs (usually kube-system)
    dnsNamespace: "kube-system"
    # Additional custom egress rules (standard NetworkPolicyEgressRule objects)
    # SECURITY: Each rule MUST specify 'to' and/or 'ports' - empty rules are rejected
    # SECURITY: Rule with only 'to' allows all ports to those destinations
    # SECURITY: Rule with only 'ports' allows those ports to all destinations
    # Example: Allow outbound to specific external service
    # customRules:
    #   - to:
    #       - ipBlock:
    #           cidr: 10.0.0.0/8
    #     ports:
    #       - protocol: TCP
    #         port: 443
    customRules: []

# Prometheus metrics configuration
# Requires redis_exporter sidecar since Valkey doesn't expose native Prometheus metrics
# NOTE: When networkPolicy.enabled=true, ensure Prometheus pods can reach port 9121
# by adding appropriate selectors to networkPolicy.allowedSelectors or disabling NetworkPolicy
metrics:
  enabled: false
  # redis_exporter sidecar image (supports Valkey 8.x/9.x)
  image:
    repository: oliver006/redis_exporter
    tag: "v1.80.1"
    pullPolicy: IfNotPresent
  # Exporter container resource limits
  resources:
    limits:
      cpu: 100m
      memory: 64Mi
    requests:
      cpu: 10m
      memory: 32Mi
  # ServiceMonitor configuration (requires Prometheus Operator CRDs)
  serviceMonitor:
    enabled: false
    # Additional labels for ServiceMonitor (e.g., for Prometheus selector)
    additionalLabels: {}
    # Namespace for ServiceMonitor (defaults to release namespace)
    namespace: ""
    # Scrape interval (must be greater than scrapeTimeout)
    # Format: integer seconds with 's' suffix (e.g., "30s", "60s")
    # Minimum: 10s
    interval: "30s"
    # Scrape timeout (must be less than interval)
    # Format: integer seconds with 's' suffix (e.g., "10s", "15s")
    # Minimum: 1s
    scrapeTimeout: "10s"
    # Scheme for scraping: "http" or "https" (empty = default to http)
    scheme: ""
    # TLS configuration for HTTPS endpoints
    # NOTE: When scheme=https, configure tlsConfig or Prometheus will fail cert verification
    # See: https://prometheus-operator.dev/docs/api-reference/api/#monitoring.coreos.com/v1.TLSConfig
    tlsConfig: {}
    # Example for self-signed certs:
    # tlsConfig:
    #   insecureSkipVerify: true
    # Example with CA certificate:
    # tlsConfig:
    #   ca:
    #     secret:
    #       name: my-ca-cert
    #       key: ca.crt
    # Honor labels from the scraped target (preserves exporter labels over target labels)
    # See: https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config
    honorLabels: false
    # Relabelings for metrics
    relabelings: []
    # Metric relabelings
    metricRelabelings: []
  # NetworkPolicy configuration for metrics scraping
  # Only used when both metrics.enabled=true and networkPolicy.enabled=true
  networkPolicy:
    # NetworkPolicy 'from' entries for Prometheus to scrape port 9121
    # NOTE: If empty and networkPolicy.enabled=true, metrics port is blocked
    # NOTE: Each entry is a standard Kubernetes NetworkPolicyPeer object
    allowedSelectors: []
    # Example: Same-namespace Prometheus (pod selector only)
    # - podSelector:
    #     matchLabels:
    #       app.kubernetes.io/name: prometheus
    # Example: Cross-namespace Prometheus in 'monitoring' namespace
    # - namespaceSelector:
    #     matchLabels:
    #       kubernetes.io/metadata.name: monitoring
    #   podSelector:
    #     matchLabels:
    #       app.kubernetes.io/name: prometheus
