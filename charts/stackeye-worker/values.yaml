# Default values for stackeye-worker
# This is a YAML-formatted file.
#
# Multi-Cluster Deployment:
# Workers deploy to remote DOKS clusters (nyc3, sfo3) and connect to
# on-prem PostgreSQL/Valkey via Tailscale VPN. Each cluster gets its own
# worker deployment with unique region configuration.
#
# ArgoCD deploys this chart to each DOKS cluster with region-specific values:
#   stackeye-worker-nyc3: worker.region=nyc3, worker.regionName="New York"
#   stackeye-worker-sfo3: worker.region=sfo3, worker.regionName="San Francisco"

# -- Worker deployment mode: "single" or "multi-region"
# Use "single" for ArgoCD multi-cluster deployment (one chart per cluster)
# Use "multi-region" for single-cluster deployment with multiple regions
mode: single

# -- Number of worker replicas
replicaCount: 2

# -- Multi-region configuration (only used when mode=multi-region)
# Note: Prefer ArgoCD multi-cluster deployment over this mode
regions:
  - id: nyc3
    name: "New York"
    enabled: true
    replicaCount: 2
  - id: sfo3
    name: "San Francisco"
    enabled: true
    replicaCount: 2

image:
  # -- Container image repository
  repository: harbor.support.tools/stackeye/worker
  # -- Image pull policy
  pullPolicy: IfNotPresent
  # -- Image tag (defaults to chart appVersion, overridden by GitOps)
  tag: ""

imagePullSecrets:
  - name: harbor-credentials

nameOverride: ""
fullnameOverride: ""

serviceAccount:
  # -- Create service account
  create: true
  # -- Service account annotations
  annotations: {}
  # -- Service account name
  name: ""

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8080"
  prometheus.io/path: "/metrics"

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 65532
  runAsGroup: 65532
  fsGroup: 65532
  seccompProfile:
    type: RuntimeDefault

securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 65532
  capabilities:
    drop:
      - ALL

# -- Worker configuration
worker:
  # -- Worker ID prefix (suffixed with pod name)
  idPrefix: "worker"
  # -- Worker region ID (short code: nyc3, sfo3, etc.)
  # Set per-cluster via ArgoCD Application values
  region: "nyc3"
  # -- Worker region display name ("New York", "San Francisco", etc.)
  # Set per-cluster via ArgoCD Application values
  regionName: "New York"
  # -- Ticker interval for probe scheduling
  tickerInterval: "10s"
  # -- Maximum concurrent probe executions
  concurrency: 10
  # -- Graceful shutdown timeout
  shutdownTimeout: "30s"

resources:
  limits:
    cpu: 500m
    memory: 256Mi
  requests:
    cpu: 100m
    memory: 128Mi

# -- No HPA by default for workers (scale via replicas)
autoscaling:
  enabled: false
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 70

nodeSelector: {}

tolerations: []

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - stackeye-worker
          topologyKey: kubernetes.io/hostname

# -- Health probes
livenessProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 10
  periodSeconds: 30
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /ready
    port: 8080
  initialDelaySeconds: 5
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

# -- Graceful shutdown for in-flight probes
terminationGracePeriodSeconds: 35

# -- ConfigMap values
# Database connection uses Tailscale IP to reach on-prem PostgreSQL
config:
  logLevel: "info"
  logFormat: "json"
  # Database connection pooling
  databaseMaxOpenConns: "10"
  databaseMaxIdleConns: "3"
  databaseConnMaxLifetime: "5m"

# -- Sealed Secrets configuration
# DATABASE_URL should use Tailscale IP: postgres://user:pass@100.x.x.x:5432/db
sealedSecrets:
  enabled: true
  encryptedData: {}

# -- ServiceMonitor for Prometheus
serviceMonitor:
  enabled: true
  interval: 30s
  scrapeTimeout: 10s
  labels: {}
