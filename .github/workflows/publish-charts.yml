name: Publish Charts

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'
      - 'library/**'
  # Note: Chart versions are decoupled from app versions.
  # Charts are only published when chart templates/values change.
  # App deployments use ArgoCD GitOps with image.tag overrides.

env:
  REGISTRY: harbor.support.tools
  REGISTRY_PATH: stackeye/charts

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Login to Harbor OCI Registry
        run: |
          helm registry login ${{ env.REGISTRY }} \
            --username ${{ secrets.HARBOR_USER }} \
            --password ${{ secrets.HARBOR_PASSWORD }}

      - name: Update chart dependencies
        run: |
          for chart in charts/*/; do
            helm dependency update "$chart"
          done

      - name: Package charts
        run: |
          mkdir -p .packages
          for chart in charts/*/; do
            helm package "$chart" -d .packages/
          done

      - name: Push charts to Harbor
        run: |
          for pkg in .packages/*.tgz; do
            echo "Pushing $pkg..."
            helm push "$pkg" oci://${{ env.REGISTRY }}/${{ env.REGISTRY_PATH }}
          done

      - name: Logout from Harbor
        if: always()
        run: helm registry logout ${{ env.REGISTRY }}
